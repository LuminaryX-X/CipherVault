<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CipherVault | Secure Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1220;
      --glass: rgba(17, 24, 39, .58);
      --stroke: rgba(255,255,255,.08);
      --glow: 0 0 30px rgba(59,130,246,.22);
      --glowG: 0 0 30px rgba(16,185,129,.18);
    }

    body{
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 30%, rgba(16,185,129,.14), transparent 55%),
        radial-gradient(1000px 700px at 10% 40%, rgba(14,165,233,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height: 100vh;
    }

    .glass{
      background: var(--glass);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid var(--stroke);
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
    }

    .ring-soft{ outline:none; border:1px solid rgba(148,163,184,.20); }
    .ring-soft:focus{
      border-color: rgba(59,130,246,.85);
      box-shadow: 0 0 0 4px rgba(59,130,246,.16), var(--glow);
    }
    .ring-soft-green:focus{
      border-color: rgba(16,185,129,.85);
      box-shadow: 0 0 0 4px rgba(16,185,129,.14), var(--glowG);
    }

    .grid-overlay{
      background-image:
        linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(ellipse at top, rgba(0,0,0,.75), transparent 65%);
      opacity: .35; pointer-events:none;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #050b16; }
    ::-webkit-scrollbar-thumb { background: rgba(59,130,246,.65); border-radius: 10px; }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.9);
      border-radius: 999px;
      animation: spin .8s linear infinite;
    }

    @keyframes pop { 0%{ transform: translateY(8px); opacity:0 } 100%{ transform: translateY(0); opacity:1 } }
    .toast-in{ animation: pop .25s ease-out; }

    @keyframes fadeIn { 0%{opacity:0} 100%{opacity:1} }
    .fade-in { animation: fadeIn .18s ease-out; }
  </style>
</head>

<body class="text-slate-100 font-sans px-4">
  <div class="fixed inset-0 grid-overlay"></div>

  <!-- Toast -->
  <div id="toastWrap" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 w-[min(560px,92vw)] hidden">
    <div class="toast-in glass rounded-2xl px-4 py-3 flex items-start gap-3">
      <div id="toastIcon" class="mt-0.5"></div>
      <div class="flex-1">
        <p id="toastTitle" class="font-semibold"></p>
        <p id="toastMsg" class="text-sm text-slate-300 mt-0.5"></p>
      </div>
      <button onclick="hideToast()" class="text-slate-400 hover:text-white transition" aria-label="Close toast" type="button">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Modal: Delete locked -->
  <div id="modalWrap" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

    <div class="relative max-w-lg mx-auto mt-24 sm:mt-28 px-4">
      <div class="glass rounded-3xl p-6 sm:p-7 border border-white/10 shadow-[0_30px_120px_rgba(0,0,0,.55)] fade-in">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-2xl bg-red-500/15 border border-red-500/25 flex items-center justify-center">
              <svg class="w-5 h-5 text-red-300" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 14h-2v-2h2v2Zm0-4h-2V6h2v6Z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold">Delete locked items?</h3>
              <p id="modalDesc" class="text-sm text-slate-300 mt-1">
                Locked items were encrypted with a different master password. Deleting them cannot be undone.
              </p>
            </div>
          </div>

          <button onclick="closeModal()" class="text-slate-400 hover:text-white transition" aria-label="Close modal" type="button">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/>
            </svg>
          </button>
        </div>

        <div class="mt-5 p-4 rounded-2xl bg-white/5 border border-white/10">
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-300">Service</span>
            <span id="modalService" class="font-mono text-white"></span>
          </div>
          <div class="mt-2 flex items-center justify-between text-sm">
            <span class="text-slate-300">Locked count</span>
            <span id="modalCount" class="font-semibold text-red-300"></span>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button onclick="closeModal()"
            class="w-full rounded-2xl py-3 font-extrabold tracking-widest uppercase bg-white/5 border border-white/10 hover:bg-white/10 transition"
            type="button">
            Cancel
          </button>

          <button id="modalConfirmBtn" onclick="confirmDeleteLocked()"
            class="w-full rounded-2xl py-3 font-extrabold tracking-widest uppercase
                   bg-gradient-to-r from-red-600 to-rose-500 hover:from-red-500 hover:to-rose-400
                   shadow-[0_0_40px_rgba(239,68,68,.20)] active:scale-[.99] transition flex items-center justify-center gap-3"
            type="button">
            <span id="modalSpinner" class="spinner hidden"></span>
            <span>Delete</span>
          </button>
        </div>

        <p class="mt-4 text-xs text-slate-400">
          Tip: If you remember the old master password, you can decrypt those entries instead of deleting.
        </p>
      </div>
    </div>
  </div>

  <main class="relative max-w-5xl mx-auto pt-10 pb-14">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full glass">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-blue-500/15 border border-blue-500/25 shadow-[0_0_35px_rgba(59,130,246,.25)]">
          <svg class="w-5 h-5 text-blue-300" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 1a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5Zm-3 8V6a3 3 0 0 1 6 0v3H9Z"/>
          </svg>
        </span>
        <div class="text-left leading-tight">
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">CipherVault</span>
          </h1>
          <p class="text-[11px] sm:text-xs tracking-[0.28em] uppercase text-slate-400">
            zero-knowledge aes-256-gcm protection
          </p>
        </div>

        <span class="ml-2 hidden sm:inline-flex items-center gap-2 text-xs text-slate-300">
          <span class="w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_18px_rgba(16,185,129,.45)]"></span>
          Local vault
        </span>
      </div>

      <p class="mt-5 text-slate-300 max-w-2xl mx-auto text-sm sm:text-base">
        Store credentials encrypted on your machine. The server never stores your master password.
      </p>
    </header>

    <!-- Cards -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Store -->
      <div class="glass rounded-3xl p-6 sm:p-8">
        <div class="flex items-center justify-between border-b border-white/10 pb-4 mb-5">
          <div class="flex items-center gap-3">
            <span class="w-11 h-11 rounded-2xl bg-blue-500/12 border border-blue-500/25 flex items-center justify-center">
              <span class="text-lg">üì•</span>
            </span>
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-blue-200">Store Vault</h2>
              <p class="text-xs text-slate-400">Encrypt & save a new credential</p>
            </div>
          </div>
          <span class="text-[11px] px-2.5 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-200">
            AES-GCM
          </span>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs uppercase tracking-widest text-slate-400 mb-2">Service</label>
            <input id="addService" type="text" placeholder="e.g., GitHub, Google"
              class="w-full bg-black/25 rounded-2xl px-4 py-3 ring-soft transition" />
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-slate-400 mb-2">Username / Email</label>
            <input id="addUsername" type="text" placeholder="user@example.com"
              class="w-full bg-black/25 rounded-2xl px-4 py-3 ring-soft transition" />
          </div>

          <!-- Password with eye -->
          <div>
            <label class="block text-xs uppercase tracking-widest text-slate-400 mb-2">Password</label>
            <div class="relative">
              <input id="addPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full bg-black/25 rounded-2xl px-4 py-3 pr-12 ring-soft transition" />
              <button class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition"
                onclick="toggleVisibility('addPassword', this)" type="button" aria-label="Toggle password visibility">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Master with eye -->
          <div class="pt-2">
            <label class="block text-xs uppercase tracking-widest text-blue-200 mb-2">Master Encryption Key</label>
            <div class="relative">
              <input id="addMaster" type="password" placeholder="Required to encrypt"
                class="w-full bg-blue-500/10 rounded-2xl px-4 py-3 pr-12 ring-soft transition border border-blue-500/20" />
              <button class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white transition"
                onclick="toggleVisibility('addMaster', this)" type="button" aria-label="Toggle master visibility">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/>
                </svg>
              </button>
            </div>
            <p class="mt-2 text-[12px] text-slate-400">
              Tip: Use a long passphrase. This key is never stored.
            </p>
          </div>

          <button id="btnSave" onclick="saveEntry()"
            class="mt-2 w-full rounded-2xl py-3.5 font-extrabold tracking-widest uppercase
                   bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400
                   shadow-[0_0_40px_rgba(59,130,246,.25)] active:scale-[.99] transition flex items-center justify-center gap-3">
            <span id="saveSpinner" class="spinner hidden"></span>
            <span>Encrypt & Secure</span>
          </button>
        </div>
      </div>

      <!-- Unlock -->
      <div class="glass rounded-3xl p-6 sm:p-8">
        <div class="flex items-center justify-between border-b border-white/10 pb-4 mb-5">
          <div class="flex items-center gap-3">
            <span class="w-11 h-11 rounded-2xl bg-emerald-500/12 border border-emerald-500/25 flex items-center justify-center">
              <span class="text-lg">üîç</span>
            </span>
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-emerald-200">Unlock Vault</h2>
              <p class="text-xs text-slate-400">Decrypt & reveal stored credentials</p>
            </div>
          </div>
          <span class="text-[11px] px-2.5 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-200">
            Multi-account
          </span>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs uppercase tracking-widest text-slate-400 mb-2">Service</label>
            <input id="getService" type="text" placeholder="e.g., github"
              class="w-full bg-black/25 rounded-2xl px-4 py-3 ring-soft ring-soft-green transition" />
          </div>

          <!-- Master decrypt with eye -->
          <div class="pt-2">
            <label class="block text-xs uppercase tracking-widest text-emerald-200 mb-2">Master Decryption Key</label>
            <div class="relative">
              <input id="getMaster" type="password" placeholder="Required to decrypt"
                class="w-full bg-emerald-500/10 rounded-2xl px-4 py-3 pr-12 ring-soft ring-soft-green transition border border-emerald-500/20" />
              <button class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 hover:text-white transition"
                onclick="toggleVisibility('getMaster', this)" type="button" aria-label="Toggle master visibility">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/>
                </svg>
              </button>
            </div>
          </div>

          <button id="btnGet" onclick="retrieveEntry(false)"
            class="mt-1 w-full rounded-2xl py-3.5 font-extrabold tracking-widest uppercase
                   bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400
                   shadow-[0_0_40px_rgba(16,185,129,.22)] active:scale-[.99] transition flex items-center justify-center gap-3">
            <span id="getSpinner" class="spinner hidden"></span>
            <span>Decrypt & Reveal</span>
          </button>

          <!-- Dropdown -->
          <div id="accountPicker" class="hidden mt-3 p-4 rounded-2xl bg-white/5 border border-white/10">
            <p class="text-[11px] uppercase tracking-widest text-slate-400 mb-2">Select account</p>
            <select id="accountSelect"
              class="w-full bg-black/25 rounded-2xl px-4 py-3 ring-soft ring-soft-green transition"></select>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <button id="btnDecryptSelected" onclick="decryptSelected()"
                class="w-full rounded-2xl py-3 font-extrabold tracking-widest uppercase
                       bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400
                       shadow-[0_0_40px_rgba(16,185,129,.22)] active:scale-[.99] transition">
                Decrypt selected
              </button>

              <button id="btnDeleteLocked" onclick="openDeleteLockedModal()"
                class="w-full rounded-2xl py-3 font-extrabold tracking-widest uppercase
                       bg-gradient-to-r from-red-600 to-rose-500 hover:from-red-500 hover:to-rose-400
                       shadow-[0_0_40px_rgba(239,68,68,.20)] active:scale-[.99] transition">
                Delete locked
              </button>
            </div>

            <p class="mt-2 text-[12px] text-slate-400">
              Locked items were encrypted with a different master password.
            </p>
          </div>

          <!-- Result -->
          <div id="resultBox" class="hidden mt-5 p-5 rounded-2xl bg-black/30 border border-white/10">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <p class="text-[11px] uppercase tracking-widest text-slate-400">Decrypted Credentials</p>

                <div class="mt-3 space-y-3">
                  <div>
                    <p class="text-[10px] uppercase tracking-widest text-slate-500">Username / Email</p>
                    <div class="flex items-center gap-2">
                      <code id="decryptedUsername" class="block mt-1 text-base sm:text-lg text-white font-mono break-all"></code>
                    </div>
                  </div>

                  <div>
                    <p class="text-[10px] uppercase tracking-widest text-slate-500">Password</p>
                    <div class="flex items-center gap-2">
                      <code id="decryptedPassword" class="block mt-1 text-xl sm:text-2xl text-white font-mono break-all"></code>
                      <button class="mt-1 text-slate-300 hover:text-white transition"
                        onclick="toggleVisibility('decryptedPassword', this, true)" type="button" aria-label="Toggle result password visibility">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/>
                        </svg>
                      </button>
                    </div>
                    <p class="text-[11px] text-slate-400 mt-1">Tip: use Copy buttons instead of showing it in public.</p>
                  </div>
                </div>
              </div>

              <div class="flex flex-col gap-2">
                <button onclick="copyUsername()" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition text-sm" type="button">Copy user</button>
                <button onclick="copyPassword()" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition text-sm" type="button">Copy pass</button>
                <button onclick="hideResult()" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition text-sm" type="button">Hide</button>
              </div>
            </div>
          </div>

          <p class="text-[12px] text-slate-400">
            Service matching is case-insensitive (GitHub == github).
          </p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-14 pt-10 border-t border-white/10 text-center">
      <p class="text-[11px] tracking-[0.35em] uppercase text-slate-400">
        Designed for Security by <span class="text-slate-100 font-semibold">Luminary</span>
      </p>

      <div class="mt-6 flex flex-wrap justify-center items-center gap-4">
        <!-- GitHub -->
        <a href="https://github.com/LuminaryX-X" target="_blank"
          class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-slate-300 hover:text-white transition hover:scale-105"
          aria-label="GitHub" title="GitHub">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/>
          </svg>
        </a>

        <!-- Telegram -->
        <a href="https://t.me/Luminary_X_X" target="_blank"
          class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-slate-300 hover:text-cyan-300 transition hover:scale-105"
          aria-label="Telegram" title="Telegram">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.14-.24.24-.43.24l.213-3.03 5.495-4.96c.239-.213-.05-.331-.37-.12l-6.79 4.27-2.94-.92c-.64-.2-.65-.64.13-.95l11.49-4.43c.53-.19 1 .13.84.95z"/>
          </svg>
        </a>

        <!-- LinkedIn -->
        <a href="https://www.linkedin.com/in/umar-fayzullayev-12a05b393/" target="_blank"
          class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-slate-300 hover:text-blue-300 transition hover:scale-105"
          aria-label="LinkedIn" title="LinkedIn">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"> 
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </a>

        <!-- Email -->
        <a href="mailto:umarfayzullayev208@gmail.com"
          class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-slate-300 hover:text-red-300 transition hover:scale-105"
          aria-label="Email" title="Email">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
          </svg>
        </a>
      </div>

      <p class="mt-6 text-[12px] text-slate-500">
        ¬© <span id="year"></span> CipherVault ‚Äî local encrypted storage.
      </p>
    </footer>
  </main>

  <script>
    // --- Globals ---
    document.getElementById('year').innerText = new Date().getFullYear();

    let toastTimer = null;
    let lastListedService = "";
    let lastListedItems = [];
    let pendingDeleteLockedIds = [];

    // --- UI helpers ---
    function showToast(title, msg, type = "success") {
      const wrap = document.getElementById('toastWrap');
      const icon = document.getElementById('toastIcon');
      const tTitle = document.getElementById('toastTitle');
      const tMsg = document.getElementById('toastMsg');

      const successIcon = `<div class="w-9 h-9 rounded-2xl bg-emerald-500/15 border border-emerald-500/25 flex items-center justify-center">
        <svg class="w-5 h-5 text-emerald-300" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg></div>`;
      const errorIcon = `<div class="w-9 h-9 rounded-2xl bg-red-500/15 border border-red-500/25 flex items-center justify-center">
        <svg class="w-5 h-5 text-red-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 14h-2v-2h2v2Zm0-4h-2V6h2v6Z"/></svg></div>`;

      icon.innerHTML = (type === "success") ? successIcon : errorIcon;
      tTitle.textContent = title;
      tMsg.textContent = msg;

      wrap.classList.remove('hidden');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(hideToast, 4500);
    }

    function hideToast(){ document.getElementById('toastWrap').classList.add('hidden'); }

    function setLoading(btnId, spinnerId, isLoading) {
      const btn = document.getElementById(btnId);
      const sp = document.getElementById(spinnerId);
      if (!btn) return;

      if (isLoading) {
        btn.setAttribute('disabled', 'true');
        btn.classList.add('opacity-80', 'cursor-not-allowed');
        if (sp) sp.classList.remove('hidden');
      } else {
        btn.removeAttribute('disabled');
        btn.classList.remove('opacity-80', 'cursor-not-allowed');
        if (sp) sp.classList.add('hidden');
      }
    }

    function hideResult(){
      document.getElementById('resultBox').classList.add('hidden');
      document.getElementById('decryptedUsername').innerText = "";
      document.getElementById('decryptedPassword').innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      document.getElementById('decryptedPassword').dataset.plain = "";
      document.getElementById('decryptedPassword').dataset.visible = "0";
    }

    // toggleVisibility:
    // - for <input>: toggles type password/text
    // - for <code>: toggles masked/plain using dataset
    function toggleVisibility(targetId, btn, isCode = false){
      const el = document.getElementById(targetId);
      if (!el) return;

      if (!isCode) {
        el.type = (el.type === "password") ? "text" : "password";
      } else {
        const plain = el.dataset.plain || "";
        const visible = el.dataset.visible === "1";
        if (!plain) return; // nothing decrypted yet

        if (visible) {
          el.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
          el.dataset.visible = "0";
        } else {
          el.innerText = plain;
          el.dataset.visible = "1";
        }
      }

      if (btn) {
        btn.classList.add('scale-95');
        setTimeout(() => btn.classList.remove('scale-95'), 120);
      }
    }

    async function copyUsername(){
      const text = (document.getElementById('decryptedUsername').innerText || "").trim();
      if (!text) return showToast("Nothing to copy", "Decrypt a username first.", "error");
      try { await navigator.clipboard.writeText(text); showToast("Copied", "Username copied.", "success"); }
      catch { showToast("Copy blocked", "Browser blocked clipboard access.", "error"); }
    }

    async function copyPassword(){
      const plain = document.getElementById('decryptedPassword').dataset.plain || "";
      if (!plain) return showToast("Nothing to copy", "Decrypt a password first.", "error");
      try { await navigator.clipboard.writeText(plain); showToast("Copied", "Password copied.", "success"); }
      catch { showToast("Copy blocked", "Browser blocked clipboard access.", "error"); }
    }

    // --- Dropdown helpers ---
    function updateDecryptSelectedState(){
      const sel = document.getElementById('accountSelect');
      const btn = document.getElementById('btnDecryptSelected');
      if (!sel || !btn || sel.options.length === 0) return;

      const opt = sel.options[sel.selectedIndex];
      const locked = opt?.dataset?.locked === "1";

      if (locked){
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
        btn.textContent = "Locked (wrong master)";
      } else {
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-not-allowed");
        btn.textContent = "Decrypt selected";
      }
    }

    function updateDeleteLockedState(){
      const btn = document.getElementById('btnDeleteLocked');
      if (!btn) return;

      const lockedCount = (lastListedItems || []).filter(x => x.locked).length;
      if (lockedCount === 0){
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
        btn.textContent = "No locked";
      } else {
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-not-allowed");
        btn.textContent = `Delete locked (${lockedCount})`;
      }
    }

    function populateAccountDropdown(items){
      const sel = document.getElementById('accountSelect');
      sel.innerHTML = "";

      for (const it of items){
        const opt = document.createElement('option');
        opt.value = String(it.id);
        opt.dataset.locked = it.locked ? "1" : "0";

        const label = (it.username && it.username.trim()) ? it.username : `Entry #${it.id}`;
        opt.textContent = it.locked ? `üîí ${label} (id:${it.id})` : `${label} (id:${it.id})`;

        sel.appendChild(opt);
      }

      // select first unlocked by default
      const firstUnlocked = Array.from(sel.options).find(o => o.dataset.locked === "0");
      if (firstUnlocked) sel.value = firstUnlocked.value;

      updateDecryptSelectedState();
    }

    // --- API calls ---
    async function saveEntry(){
      const data = {
        service: document.getElementById('addService').value.trim(),
        username: document.getElementById('addUsername').value.trim(),
        password: document.getElementById('addPassword').value,
        master_password: document.getElementById('addMaster').value
      };

      if (!data.service || !data.password || !data.master_password) {
        showToast("Missing fields", "Service, password and master key are required.", "error");
        return;
      }

      setLoading("btnSave", "saveSpinner", true);
      try {
        const r = await fetch('/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const res = await r.json().catch(() => ({}));
        if (r.ok) {
          showToast("Saved", res.message || "Credential stored securely.", "success");
          document.getElementById('addService').value = '';
          document.getElementById('addUsername').value = '';
          document.getElementById('addPassword').value = '';
          document.getElementById('addMaster').value = '';
        } else {
          showToast("Error", res.detail || "Failed to save entry.", "error");
        }
      } catch {
        showToast("Server unreachable", "Could not connect to API.", "error");
      } finally {
        setLoading("btnSave", "saveSpinner", false);
      }
    }

    async function decryptById(id, master_password){
      const r = await fetch(`/get_by_id/${encodeURIComponent(id)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ master_password })
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        showToast("Denied", data.detail || "Failed to decrypt.", "error");
        return;
      }

      document.getElementById('decryptedUsername').innerText = data.username || "";
      const passEl = document.getElementById('decryptedPassword');
      passEl.dataset.plain = data.password || "";
      passEl.dataset.visible = "0";
      passEl.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";

      document.getElementById('resultBox').classList.remove('hidden');
      showToast("Decrypted", `Unlocked entry #${id}.`, "success");
    }

    async function decryptSelected(){
      const master_password = document.getElementById('getMaster').value;
      const sel = document.getElementById('accountSelect');
      const id = sel.value;

      const opt = sel.options[sel.selectedIndex];
      const locked = opt?.dataset?.locked === "1";

      if (locked){
        return showToast("Locked entry", "This item was encrypted with a different master password.", "error");
      }
      if (!id) return showToast("Select account", "Pick an account first.", "error");
      if (!master_password) return showToast("Missing key", "Master key is required.", "error");

      await decryptById(id, master_password);
      document.getElementById('getMaster').value = '';
    }

    async function retrieveEntry(silentRefresh = false){
      const service = document.getElementById('getService').value.trim();
      const master_password = document.getElementById('getMaster').value;

      if (!service || !master_password) {
        showToast("Missing fields", "Service and master key are required.", "error");
        return;
      }

      lastListedService = service;
      hideResult();
      document.getElementById('accountPicker').classList.add('hidden');
      setLoading("btnGet", "getSpinner", true);

      try {
        const r = await fetch(`/list/${encodeURIComponent(service)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ master_password })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          showToast("Denied", data.detail || "Failed to list entries.", "error");
          return;
        }

        const items = data.items || [];
        lastListedItems = items;

        updateDeleteLockedState();

        if (items.length === 0) {
          showToast("Not found", `No entries saved for "${service}".`, "error");
          return;
        }

        // if only one and unlocked => decrypt immediately
        if (items.length === 1) {
          if (items[0].locked) {
            showToast("Locked", "This entry was encrypted with a different master password.", "error");
            return;
          }
          await decryptById(items[0].id, master_password);
          document.getElementById('getMaster').value = '';
          return;
        }

        // multiple accounts => dropdown
        populateAccountDropdown(items);
        document.getElementById('accountPicker').classList.remove('hidden');
        updateDeleteLockedState();

        if (!silentRefresh) {
          showToast("Multiple accounts", "Pick one account from the dropdown.", "success");
        }
      } catch {
        showToast("Server unreachable", "Could not connect to API.", "error");
      } finally {
        setLoading("btnGet", "getSpinner", false);
      }
    }

    // --- Modal logic for deleting locked items ---
    function openDeleteLockedModal(){
      const master_password = document.getElementById('getMaster').value;
      if (!master_password) {
        return showToast("Missing key", "Enter master key first (used to authorize deletion).", "error");
      }

      const locked = (lastListedItems || []).filter(x => x.locked).map(x => x.id);
      if (locked.length === 0) {
        return showToast("Nothing to delete", "No locked items found for this service.", "success");
      }

      pendingDeleteLockedIds = locked;

      document.getElementById('modalService').innerText = lastListedService || "-";
      document.getElementById('modalCount').innerText = String(locked.length);
      document.getElementById('modalWrap').classList.remove('hidden');
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      document.getElementById('modalWrap').classList.add('hidden');
      document.body.style.overflow = "";
      pendingDeleteLockedIds = [];
      setModalLoading(false);
    }

    function setModalLoading(isLoading){
      const btn = document.getElementById('modalConfirmBtn');
      const sp = document.getElementById('modalSpinner');
      if (isLoading){
        btn.setAttribute('disabled', 'true');
        btn.classList.add('opacity-80', 'cursor-not-allowed');
        sp.classList.remove('hidden');
      } else {
        btn.removeAttribute('disabled');
        btn.classList.remove('opacity-80', 'cursor-not-allowed');
        sp.classList.add('hidden');
      }
    }

    async function confirmDeleteLocked(){
      const master_password = document.getElementById('getMaster').value;
      if (!master_password) {
        closeModal();
        return showToast("Missing key", "Enter master key first.", "error");
      }
      if (!pendingDeleteLockedIds.length) {
        closeModal();
        return;
      }

      setModalLoading(true);

      let deleted = 0;
      for (const id of pendingDeleteLockedIds) {
        try {
          const r = await fetch(`/delete/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ master_password })
          });

          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            showToast("Delete failed", data.detail || `Failed at item #${id}`, "error");
            break;
          }
          deleted += 1;
        } catch {
          showToast("Server unreachable", "Could not connect to API.", "error");
          break;
        }
      }

      closeModal();
      showToast("Cleanup done", `Deleted ${deleted}/${pendingDeleteLockedIds.length} locked items.`, "success");

      // refresh list (silent)
      await retrieveEntry(true);
    }

    // close modal on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const wrap = document.getElementById('modalWrap');
        if (!wrap.classList.contains('hidden')) closeModal();
      }
    });

    // accountSelect change handler
    document.addEventListener("DOMContentLoaded", () => {
      const sel = document.getElementById("accountSelect");
      if (sel) sel.addEventListener("change", updateDecryptSelectedState);

      // default masked result
      hideResult();
    });
  </script>
</body>
</html>